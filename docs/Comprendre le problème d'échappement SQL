# Comprendre le problÃ¨me d'Ã©chappement SQL

## ğŸ¯ Le problÃ¨me en une phrase

L'apostrophe dans "Caisse d'allocations familiales" est interprÃ©tÃ©e comme la **fin de la chaÃ®ne SQL**, ce qui casse la syntaxe de ta requÃªte.

---

## ğŸ  Analogie : La lettre mal adressÃ©e

Imagine que tu envoies une lettre avec cette adresse :

```
Monsieur Jean D'Arcy
Rue de l'Ã‰glise 12
1000 Lausanne
```

Si le systÃ¨me postal utilise l'apostrophe comme sÃ©parateur de champs, il va lire :

| Champ | Valeur lue |
|-------|------------|
| Nom | `Monsieur Jean D` |
| ??? | `Arcy` â† ???  |
| Rue | `Rue de l` |
| ??? | `Ã‰glise 12` â† ??? |

**Le systÃ¨me est perdu** car l'apostrophe a un double sens :
1. CaractÃ¨re normal dans un nom (D'Arcy)
2. SÃ©parateur technique du systÃ¨me

C'est exactement ce qui se passe avec SQL !

---

## ğŸ” Analyse visuelle du problÃ¨me

### Ce que tu Ã©cris dans n8n :

```
{{ $json.debtor_name }}  â†’  "Caisse d'allocations familiales"
```

### Ce que n8n gÃ©nÃ¨re (interpolation directe) :

```sql
SELECT * FROM invoice_vendor_mappings
WHERE debtor_name ILIKE '%Caisse d'allocations familiales%'
```

### Ce que PostgreSQL comprend :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHERE debtor_name ILIKE '%Caisse d'allocations familiales%'                â”‚
â”‚                                    â†‘                                        â”‚
â”‚                          PostgreSQL voit ici                                â”‚
â”‚                          la FIN de la chaÃ®ne                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PostgreSQL dÃ©compose ainsi :

  '%Caisse d'        â†’  âœ… ChaÃ®ne valide (entre guillemets simples)
  allocations        â†’  âŒ Mot-clÃ© inconnu ? Nom de colonne ?
  familiales%'       â†’  âŒ Syntaxe invalide
```

### SchÃ©ma de l'interprÃ©tation :

```
Code SQL envoyÃ©:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ...ILIKE '%Caisse d'allocations familiales%'                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚         â”‚                      â”‚
            â–¼         â–¼                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  '  â”‚   â”‚  '  â”‚              â”‚    '    â”‚
         â”‚STARTâ”‚   â”‚ END â”‚              â”‚ORPHELINEâ”‚
         â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚         â”‚                      â”‚
            â–¼         â–¼                      â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ChaÃ®ne:  â”‚  â”‚   InterprÃ©tÃ©    â”‚  â”‚ Erreur â”‚
      â”‚ %Caisse dâ”‚  â”‚   comme code    â”‚  â”‚ syntaxeâ”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ La solution : les requÃªtes paramÃ©trÃ©es

### Principe

Au lieu d'injecter la valeur directement dans le SQL, on utilise des **placeholders** (`$1`, `$2`, etc.) et on passe les valeurs sÃ©parÃ©ment.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AVANT (dangereux)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Template:  "SELECT * WHERE name = '{{ valeur }}'"             â”‚
â”‚                                       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚   Valeur:    "D'Arcy"                      â”‚                    â”‚
â”‚                  â”‚                         â”‚                    â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â–º injection â—„â”€â”€â”€â”€â”˜                    â”‚
â”‚                                 â”‚                               â”‚
â”‚                                 â–¼                               â”‚
â”‚   RÃ©sultat:  "SELECT * WHERE name = 'D'Arcy'"                   â”‚
â”‚                                     â†‘                           â”‚
â”‚                              SYNTAXE CASSÃ‰E                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APRÃˆS (sÃ©curisÃ©)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   RequÃªte:     "SELECT * WHERE name = $1"                       â”‚
â”‚   ParamÃ¨tres:  [$1 = "D'Arcy"]                                  â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚   PostgreSQL    â”‚                                â”‚
â”‚              â”‚   sait que $1   â”‚                                â”‚
â”‚              â”‚   est une valeurâ”‚                                â”‚
â”‚              â”‚   PAS du code   â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                        â”‚                                        â”‚
â”‚                        â–¼                                        â”‚
â”‚   PostgreSQL Ã©chappe automatiquement: 'D''Arcy'                 â”‚
â”‚                                         â†‘â†‘                      â”‚
â”‚                                    apostrophe                   â”‚
â”‚                                    doublÃ©e = safe               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Application dans n8n

### Configuration du node PostgreSQL

#### Avant (ta configuration actuelle) :

```javascript
// Dans le champ "Query" du node
`SELECT mandat_bc, sous_mandat_bc, confidence, usage_count
FROM invoice_vendor_mappings m
JOIN bc_companies c ON m.company_id = c.id
WHERE c.bc_company_id = '{{ $json.bc_company_id }}'
  AND m.debtor_name ILIKE '%{{ $json.debtor_name }}%'
ORDER BY confidence DESC, usage_count DESC
LIMIT 1`
```

#### AprÃ¨s (configuration sÃ©curisÃ©e) :

```javascript
// Dans le champ "Query" du node
`SELECT mandat_bc, sous_mandat_bc, confidence, usage_count
FROM invoice_vendor_mappings m
JOIN bc_companies c ON m.company_id = c.id
WHERE c.bc_company_id = $1
  AND m.debtor_name ILIKE '%' || $2 || '%'
ORDER BY confidence DESC, usage_count DESC
LIMIT 1`
```

```javascript
// Dans "Query Parameters" (tableau)
[
  "{{ $json.bc_company_id }}",    // â†’ $1
  "{{ $json.debtor_name }}"       // â†’ $2
]
```

### Explication de la syntaxe `'%' || $2 || '%'`

```
'%'  ||  $2  ||  '%'
 â”‚      â”‚       â”‚
 â”‚      â”‚       â””â”€â”€ ChaÃ®ne littÃ©rale: %
 â”‚      â”‚
 â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ParamÃ¨tre sÃ©curisÃ©: Caisse d'allocations familiales
 â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ChaÃ®ne littÃ©rale: %

 || = opÃ©rateur de concatÃ©nation PostgreSQL

RÃ©sultat: %Caisse d'allocations familiales%
```

---

## ğŸš¨ Bonus : pourquoi c'est aussi un problÃ¨me de sÃ©curitÃ©

### L'injection SQL

Un utilisateur malveillant pourrait exploiter cette faille :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ScÃ©nario d'attaque                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Valeur malveillante entrÃ©e:                                   â”‚
â”‚   "'; DROP TABLE invoice_vendor_mappings; --"                   â”‚
â”‚                                                                 â”‚
â”‚   RequÃªte gÃ©nÃ©rÃ©e:                                              â”‚
â”‚   SELECT * FROM mappings                                        â”‚
â”‚   WHERE name = ''; DROP TABLE invoice_vendor_mappings; --'      â”‚
â”‚                 â†‘                                      â†‘        â”‚
â”‚           fin chaÃ®ne                             commentaire    â”‚
â”‚           vide                                   (ignore reste) â”‚
â”‚                                                                 â”‚
â”‚   PostgreSQL exÃ©cute:                                           â”‚
â”‚   1. SELECT * FROM mappings WHERE name = ''    â† requÃªte vide   â”‚
â”‚   2. DROP TABLE invoice_vendor_mappings        â† CATASTROPHE!   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Avec les requÃªtes paramÃ©trÃ©es, cette attaque est **impossible** car PostgreSQL traite toujours `$1` comme une valeur, jamais comme du code.

---

## ğŸ“‹ Checklist de correction

- [ ] Ouvrir le workflow "QR-Reader" dans n8n
- [ ] Ã‰diter le node "RAG Lookup"
- [ ] Remplacer les interpolations `{{ }}` par des placeholders `$1`, `$2`
- [ ] Activer "Query Parameters" dans les options
- [ ] Ajouter les paramÃ¨tres dans l'ordre
- [ ] Tester avec "Caisse d'allocations familiales"
- [ ] Tester avec d'autres cas spÃ©ciaux (guillemets, backslash, etc.)

---

## ğŸ“š Ressources

- [Documentation n8n - Node PostgreSQL](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.postgres/)
- [PostgreSQL - ParamÃ¨tres prÃ©parÃ©s](https://www.postgresql.org/docs/current/sql-prepare.html)
- [OWASP - SQL Injection Prevention](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
